---
sort: 12
---

# 垂直领域小模型快速训练（一）

*   [算法开发手册](https://kg-nlp.github.io/Algorithm-Project-Manual/大模型/垂直领域小模型快速训练（一）.html)

*   [个人知乎](https://www.zhihu.com/people/zhangyj-n)

## 背景

承接之前内容
* [垂直领域小模型快速训练](https://kg-nlp.github.io/Algorithm-Project-Manual/大模型/垂直领域小模型快速训练.html)
* [LLM数据处理](https://kg-nlp.github.io/Algorithm-Project-Manual/大模型/LLM数据处理.html)

## 20230714 第一轮数据处理结果

*   数据
    * Total sentences num: 82609   # 按照换行,句号,问号,叹号
    * Total documents num: 2217
    * Total tokens num: 4197617
    * Average tokens per sentence: 50.81
    * Average tokens per document: 1893.38

*   模型训练

| 基础模型                | 超参 |
| ------------------- | -- |
| ernie-3.0-base-zh   |    |
| ernie-3.0-medium-zh |    |
| ernie-3.0-mini-zh   |    |
| ernie-3.0-micro-zh  |    |

以上模型超参

```bash

MODEL_NAME="ernie-3.0-mini-zh"
MODEL_NAME="ernie-3.0-micro-zh"
MODEL_NAME="ernie-3.0-medium-zh"
MODEL_NAME="ernie-3.0-base-zh"

python -u -m paddle.distributed.launch \
    --gpus "0,1,2,3" \
    --log_dir "output/${MODEL_NAME}/logs" \
    run_pretrain.py \
    --model_name_or_path ${MODEL_NAME} \
    --tokenizer_name_or_path ${MODEL_NAME} \
    --input_dir  /home/Algorithm_Frame/LLM/process/data/xxx/xxx \
    --output_dir output/${MODEL_NAME} \
    --split 198,1,1 \
    --binary_head True \
    --max_seq_len 256 \
    --micro_batch_size 128 \
    --max_steps 2400 \
    --checkpoint_steps 240 \
    --save_steps 320 \
    --logging_freq 160 \
    --eval_freq 160

```
* 损失曲线


```
/opt/conda/bin/visualdl service upload --logdir ./output/ernie-3.0-micro-zh/runs/
```
[micro损失](https://paddlepaddle.org.cn/paddle/visualdl/service/app?id=9c1a86b5fcd1d05524aef8ad0d9e8c76)


```
/opt/conda/bin/visualdl service upload --logdir ./output/ernie-3.0-mini-zh/runs/
```
[mini损失](https://paddlepaddle.org.cn/paddle/visualdl/service/app?id=6fef7afb50376cd17457e8f288e85ed1)

```
/opt/conda/bin/visualdl service upload --logdir ./output/ernie-3.0-medium-zh/runs/
```
[medium损失](https://paddlepaddle.org.cn/paddle/visualdl/service/app?id=3b8539ff324f1d9390319a68591b0289)

```
/opt/conda/bin/visualdl service upload --logdir ./output/ernie-3.0-base-zh/runs/
```
[base损失](https://paddlepaddle.org.cn/paddle/visualdl/service/app?id=98eb8620aec6cf36da4251d278d2ed5a)

* 模型对比结果

业务领域训练超参设置

```bash
    --device "gpu" \
    --max_seq_length 128 \
    --model_name pretrain_model/${MODEL_NAME} \
    --batch_size 128 \
    --early_stop_nums 10 \
    --learning_rate 5e-5 \
    --epochs 50
```

| 基础模型 | 增量模型 | 基础模型结果 | 增量模型结果 |
| --- | --- | --- | --- |
| ernie-3.0-micro-zh ep24 | model_ernie_2400_micro ep16  | 成本数据 预测准确率0.775000<br>成本数据 容错预测准确率0.780000<br>质量验收 预测准确率0.819113<br>质量验收 容错预测准确率0.846416<br>进度计划 预测准确率0.899408<br>进度计划 容错预测准确率0.934911<br>总预测准确率0.851000<br>总容错预测准确率0.878000<br> |成本数据 预测准确率0.760<br>成本数据 容错预测准确率0.770<br>质量验收 预测准确率0.802<br>质量验收 容错预测准确率0.823<br>进度计划 预测准确率0.886<br>进度计划 容错预测准确率0.939<br>总预测准确率0.836<br>总容错预测准确率0.871 |
| ernie-3.0-mini-zh  ep28 | model_ernie_2400_mini ep34   |   成本数据 预测准确率0.775000<br>成本数据 容错预测准确率0.775000<br>质量验收 预测准确率0.788396<br>质量验收 容错预测准确率0.832765<br>进度计划 预测准确率0.915187<br>进度计划 容错预测准确率0.950690<br>总预测准确率0.850000<br>总容错预测准确率0.881000<br>     |  成本数据 预测准确率0.790000<br>成本数据 容错预测准确率0.800000<br>质量验收 预测准确率0.843003<br>质量验收 容错预测准确率0.863481<br>进度计划 预测准确率0.905325<br>进度计划 容错预测准确率0.956607<br>总预测准确率0.864000<br>总容错预测准确率0.898000<br> |
| ernie-3.0-medium-zh ep44 | model_ernie_2400_medium ep11 |    成本数据 预测准确率0.760000<br>成本数据 容错预测准确率0.760000<br>质量验收 预测准确率0.825939<br>质量验收 容错预测准确率0.849829<br>进度计划 预测准确率0.927022<br>进度计划 容错预测准确率0.952663<br>总预测准确率0.864000<br>总容错预测准确率0.884000<br>    |  成本数据 预测准确率0.760000<br>成本数据 容错预测准确率0.760000<br>质量验收 预测准确率0.802048<br>质量验收 容错预测准确率0.843003<br>进度计划 预测准确率0.923077<br> 进度计划 容错预测准确率0.950690<br>总预测准确率0.855000<br>总容错预测准确率0.881000 |
| ernie-3.0-base-zh  ep21 | model_ernie_2400_base ep19   |    成本数据 预测准确率0.760000<br>成本数据 容错预测准确率0.770000<br>质量验收 预测准确率0.832765<br>质量验收 容错预测准确率0.866894<br>进度计划 预测准确率0.919132<br>进度计划 容错预测准确率0.942801<br>总预测准确率0.862000<br>总容错预测准确率0.886000<br>    | 成本数据 预测准确率0.770000<br>成本数据 容错预测准确率0.770000<br>质量验收 预测准确率0.829352<br>质量验收 容错预测准确率0.856655<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.944773<br>总预测准确率0.865000<br>总容错预测准确率0.884000  |


|增量模型 | 增量模型结果|
|---|---|
|model_ernie_1600_micro |成本数据 预测准确率0.760000<br>成本数据 容错预测准确率0.765000<br>质量验收 预测准确率0.788396<br>质量验收 容错预测准确率0.832765<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.956607<br>总预测准确率0.851000<br>总容错预测准确率0.882000<br>|
|model_ernie_1600_mini ep34|成本数据 预测准确率0.770000<br>成本数据 容错预测准确率0.775000<br>质量验收 预测准确率0.839590<br>质量验收 容错预测准确率0.873720<br>进度计划 预测准确率0.893491<br>进度计划 容错预测准确率0.942801<br>总预测准确率0.853000<br>总容错预测准确率0.889000<br>|
|model_ernie_1600_medium ep17|成本数据 预测准确率0.745000<br>成本数据 容错预测准确率0.750000<br>质量验收 预测准确率0.819113<br>质量验收 容错预测准确率0.843003<br>进度计划 预测准确率0.932939<br>进度计划 容错预测准确率0.958580<br>总预测准确率0.862000<br>总容错预测准确率0.883000<br>|
|model_ernie_1600_base ep26|成本数据 预测准确率0.785000<br>成本数据 容错预测准确率0.790000<br>质量验收 预测准确率0.812287<br>质量验收 容错预测准确率0.856655<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.956607<br>总预测准确率0.863000<br>总容错预测准确率0.894000<br>|


|增量模型 | 增量模型结果|
|---|---|
|model_ernie_320_micro ep17|成本数据 预测准确率0.750000<br>成本数据 容错预测准确率0.760000<br>质量验收 预测准确率0.815700<br>质量验收 容错预测准确率0.843003<br>进度计划 预测准确率0.899408<br>进度计划 容错预测准确率0.940828<br>总预测准确率0.845000<br>总容错预测准确率0.876000<br>|
|model_ernie_320_mini ep31|成本数据 预测准确率0.750000<br>成本数据 容错预测准确率0.750000<br>质量验收 预测准确率0.808874<br>质量验收 容错预测准确率0.846416<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.950690<br>总预测准确率0.855000<br>总容错预测准确率0.880000<br>|
|model_ernie_320_medium ep20|成本数据 预测准确率0.775000<br>成本数据 容错预测准确率0.785000<br>质量验收 预测准确率0.832765<br>质量验收 容错预测准确率0.870307<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.956607<br>总预测准确率0.867000<br>总容错预测准确率0.897000<br>|
|model_ernie_320_base ep15|成本数据 预测准确率0.790000<br>成本数据 容错预测准确率0.795000<br>质量验收 预测准确率0.825939<br>质量验收 容错预测准确率0.846416<br>进度计划 预测准确率0.923077<br>进度计划 容错预测准确率0.942801<br>总预测准确率0.868000<br>总容错预测准确率0.885000<br>|


|增量模型 | 增量模型结果|
|---|---|
|model_ernie_960_micro ep45|成本数据 预测准确率0.770000<br>成本数据 容错预测准确率0.770000<br>质量验收 预测准确率0.822526<br>质量验收 容错预测准确率0.853242<br>进度计划 预测准确率0.881657<br>进度计划 容错预测准确率0.930966<br>总预测准确率0.842000<br>总容错预测准确率0.876000<br>|
|model_ernie_960_mini ep30|成本数据 预测准确率0.730<br>成本数据 容错预测准确率0.740<br>质量验收 预测准确率0.829<br>质量验收 容错预测准确率0.863<br>进度计划 预测准确率0.911<br>进度计划 容错预测准确率0.953<br>总预测准确率0.851<br>总容错预测准确率0.884<br>|
|model_ernie_960_medium ep11|成本数据 预测准确率0.740000<br>成本数据 容错预测准确率0.750000<br>质量验收 预测准确率0.829352<br>质量验收 容错预测准确率0.856655<br>进度计划 预测准确率0.934911<br>进度计划 容错预测准确率0.972387<br>总预测准确率0.865000<br>总容错预测准确率0.894000<br>|
|model_ernie_960_base ep15|成本数据 预测准确率0.805000<br>成本数据 容错预测准确率0.805000<br>质量验收 预测准确率0.836177<br>质量验收 容错预测准确率0.863481<br>进度计划 预测准确率0.928994<br>进度计划 容错预测准确率0.958580<br>总预测准确率0.877000<br>总容错预测准确率0.900000<br>|


<br>

> 表格中ep表示epoch



比较原模型,和增量模型第320step,960step,1600step,2400step模型结果  

比较不同基础模型结果


|模型|基础结果|320结果|960结果|1600结果|2400结果|
|---|---|---|---|---|---|
|micro|总预测准确率0.851<br>总容错预测准确率0.878|总预测准确率0.845<br>总容错预测准确率0.870|总预测准确率0.842<br>总容错预测准确率0.876|总预测准确率0.851<br>总容错预测准确率0.882|总预测准确率0.836<br>总容错预测准确率0.871|
|mini|总预测准确率0.850<br>总容错预测准确率0.881|总预测准确率0.855<br>总容错预测准确率0.880|总预测准确率0.851<br>总容错预测准确率0.884|总预测准确率0.853<br>总容错预测准确率0.889|总预测准确率0.864<br>总容错预测准确率0.898|
|medium|总预测准确率0.864<br>总容错预测准确率0.884|==总预测准确率0.867<br>总容错预测准确率0.897==|==总预测准确率0.865<br>总容错预测准确率0.894==|总预测准确率0.862<br>总容错预测准确率0.883|总预测准确率0.855<br>总容错预测准确率0.881|
|base|总预测准确率0.862<br>总容错预测准确率0.886|总预测准确率0.868<br>总容错预测准确率0.885|总预测准确率0.877<br>总容错预测准确率0.900|总预测准确率0.863<br>总容错预测准确率0.894|总预测准确率0.865<br>总容错预测准确率0.884|

* 结果

第一轮测试结果 选择medium 960结果